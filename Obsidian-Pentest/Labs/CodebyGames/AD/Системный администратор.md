## Codeby Games "Системный администратор" Active Directory WriteUp by artrone
Источник: https://teletype.in/@hackerblog/zGb1QoS6zsC

Доброго дня, мои начинающие хацкеры! В последнее время, стало популярным ломать АД. Не знаю, с чем это связано, но да ладно. Сегодня разберем интересную руму, которая заставит немного подумать.
## Разведка
Как обычно, всегда начинаем с разведки.
`nmap -A 192.168.2.3`

![[Pasted image 20240625235220.png]]

Сразу обращаем внимание на FTP с анонимным доступом. Опытным путем попробуем авторизоваться и проверить содержимое.
`ftp anonymous@192.168.2.3`

![[Pasted image 20240625235306.png]]
Сразу заприметим учетки `vlad.ivanov` и `ekaterina.smirnova`, которые могут нам помочь в будущем.

Теперь необходимо найти что-то полезное. Находим в папке Иванова файлик "reminder.txt", в котором записан пароль
`You_Shall_Not_Pass` <---

![[Pasted image 20240625235342.png]]

Теперь, когда у нас есть учетка, попробуем сдампить данные с домена. Я буду использовать bloodhound (в частности, bloodhound-python для дампа). Предварительно, можно запросить TGT билет, если потребуется и заэкспортить его:

`impacket-getTGT 'codeby.cdb/vlad.ivanov:You_Shall_Not_Pass' -dc-ip 192.168.2.3`

Команда `impacket-getTGT` входит в состав набора инструментов Impacket, который представляет собой коллекцию классов Python для работы с сетевыми протоколами. Инструмент `getTGT` специально разработан для `выполнения атаки Golden Ticket`, которая представляет собой тип атаки на домен Windows с использованием украденных билетов `Kerberos.`

Вот описание опций, используемых в команде:
`impacket-getTGT`: Это команда для выполнения инструмента getTGT из набора Impacket.
    `'codeby.cdb/vlad.ivanov:You_Shall_Not_Pass'`: Это TGT-билет, который необходимо подделать. Он состоит из следующих компонентов:
        `codeby.cdb`: Это целевой домен.
        `vlad.ivanov`: Это целевой пользователь.
        `You_Shall_Not_Pass`: Это пароль для целевого пользователя.
    `-dc-ip 192.168.2.3`: Эта опция указывает IP-адрес контроллера домена, на который будет направлена атака.

Команда попытается создать поддельный билет Kerberos TGT для указанного пользователя в целевом домене, используя предоставленный пароль. В случае успеха злоумышленник сможет использовать этот билет для аутентификации в качестве целевого пользователя и доступа к ресурсам домена.

>С помощью этих действий, можно использовать авторизацию по билету, не используя пароля.

```bash
export KRB5CCNAME=vlad.ivanov.ccache

bloodhound-python -u "vlad.ivanov" -p "You_Shall_Not_Pass" -d codeby.cdb -c ALL -ns 192.168.2.3
```

![[Pasted image 20240626000143.png]]

Команда bloodhound-python - это реализация на языке Python инструмента BloodHound, который представляет собой графический инструмент, используемый для изучения и анализа сред Active Directory. Команда bloodhound-python позволяет выполнять тот же анализ из командной строки.

Вот описание опций, используемых в команде:
    `bloodhound-python`: Это команда для выполнения инструмента BloodHound Python.
    `-u "vlad.ivanov"`: Эта опция указывает имя пользователя, которое будет использоваться для аутентификации.
    `-p "You_Shall_Not_Pass"`: Эта опция задает пароль для указанного пользователя.
    `-d codeby.cdb`: Эта опция указывает целевой домен для анализа.
    `-c ALL`: Эта опция задает тип выполняемых запросов. В данном случае будут выполнены все доступные запросы.
    `-ns 192.168.2.3`: Эта опция указывает IP-адрес сервера.

Команда выполнит серию запросов к указанной среде Active Directory и сохранит результаты в базе данных Neo4j. Запросы будут выполняться с использованием указанных учетных данных пользователя и будут анализировать отношения между различными объектами в среде Active Directory, такими как пользователи, группы и компьютеры.

![[Pasted image 20240626000950.png]]

Теперь идем в сам bloodhound.
`sudo neo4j start`
`bloodhound`

> [!Note]
Если возникли проблемы: https://www.kali.org/tools/bloodhound/

Теперь загрузим наши сдампленные файлы:
![[Pasted image 20240626001120.png]]

Перейдя во вкладку "Find Shortest Paths to Domain Admins", мы видим следующее:
![[Pasted image 20240626001135.png]]
Становится очевидно, что следующим нашим шагом будет получение учетки Алексея Ибрагимова, которая поможет нам получить админа и скомпрометировать домен, соответственно.

Но как нам быть, если у нас нет его пароля?

## Пользовательский флаг

Давайте вернемся к FTP.

После просмотра папки Смироновой, находим файл "notes.txt", в котором говорится следующее:
`ftp anonymous@192.168.2.3`

notes.txt
```
Привет,  
Я поменял пароль, но не помню точно на кого,  
коллеги, проверьте пожалуйста - You_Shall_Not_Pass@@#

С наилучшими пожеланиями,  
Тупой админ
```

Интересная ситуация, не правда ли? Если хорошенько подумать, то вспомним, что у нас осталось 2 учетки без пароля: `aleksey.ibragimov` и `ekaterina.smirnova`

Соответственно, мы можем сделать стандартный Password Spraying с паролем `You_Shall_Not_Pass@@#`

Давайте так и поступим. Для этого создадим файлик с логинами:

`# cat names.txt 
```
ekaterina.smirnova 
aleksey.ibragimov
```

Далее с помощью crackmapexec выполним спрэйинг
`crackmapexec smb 192.168.2.3 -u names.txt -p 'You_Shall_Not_Pass@@#'`
p.s. думаю, тут все понятно, перебираем names с паролем ^-^

> [!Note]
> Я буду использовать NetExec
> https://www.kali.org/tools/netexec/
> https://www.netexec.wiki/

![[Pasted image 20240626010209.png]]

Видно, что пароль подошел для Алексея Ибрагимова. Отлично! Предлагаю подключиться по WinRM с помощью Evil-winrm

```bash
evil-winrm -u 'CODEBY\ALEKSEY.IBRAGIMOV' -p You_Shall_Not_Pass@@# -i 192.168.2.3
```

Команда `evil-winrm` - это утилита командной строки, которая позволяет подключаться к удаленным системам Windows с использованием протокола WinRM (Windows Remote Management).

Здесь краткое объяснение используемых в команде параметров:

- `evil-winrm`: Это команда для запуска утилиты evil-winrm.
- `-u 'CODEBY\ALEKSEY.IBRAGIMOV'`: Этот параметр указывает имя пользователя для подключения к удаленной системе.
- `-p 'You_Shall_Not_Pass@@#'`: Этот параметр указывает пароль для указанного пользователя.
- `-i 192.168.2.3`: Этот параметр указывает IP-адрес удаленной системы, к которой нужно подключиться.

Команда попытается подключиться к удаленной системе Windows с использованием указанного имени пользователя и пароля по протоколу WinRM. Если подключение удалось, вы сможете выполнять команды на удаленной системе.
![[Pasted image 20240626011155.png]]
Пользовательский флаг получен.
p.s. если не знаешь, вот: cat user.txt
## Эскалация привелегий

Давайте вернемся в Bloodhound, чтобы еще раз посмотреть на права аккаунта Алексея и посмотреть пути эскалации.
![[Pasted image 20240626012847.png]]
Видим, что наш пользователь обладает правами для атаки "DCSync"
_Подробнее о DCSync: https://habr.com/ru/companies/rvision/articles/709866/

Отлично, давайте так и поступим.
Необходимо сдампить хэши. Я буду использовать secretsdump из набора Impacket.
![[Pasted image 20240626013013.png]]
```
impacket-secretsdump -just-dc aleksey.ibragimov:You_Shall_Not_Pass@@#@192.168.2.3 -outputfile dc_hash
```

Команда `impacket-secretsdump` - это утилита командной строки, которая позволяет снимать дамп секретных данных с домена Active Directory.

Здесь краткое объяснение используемых в команде параметров:

- `impacket-secretsdump`: Это команда для запуска утилиты secretsdump из Impacket.
- `-just-dc`: Этот параметр указывает, что нужно снимать дамп с домена, используя только доменного контроллера.
- `aleksey.ibragimov:You_Shall_Not_Pass@@#@192.168.2.3`: Этот параметр указывает имя пользователя и пароль домена в формате `<username>:<password>@@<domain_netbios_name>` и IP-адрес доменного контроллера.
- `-outputfile dc_hash`: Этот параметр указывает имя файла, в который будет записан дамп секретных данных домена.

Команда попытается подключиться к доменному контроллеру по указанному IP-адресу с использованием указанных учетных данных и снять дамп секретных данных домена в файл `dc_hash`.

---

После успешного дампа, проведем атаку Pass-The-Hash, которая позволяет авторизоваться с помощью хэша по протоколу NTLM, избегая пароль.

_Подробнее о Pass-The-Hash: [https://hackware.ru/?p=11287](https://hackware.ru/?p=11287)_

Для реализации атаки, использую psexec из того же набора Impacket

![[Pasted image 20240626013610.png]]
Как мы видим, мы получили шелл от имени системы. Забираем флаг.


Команда `impacket-psexec` - это утилита командной строки, которая позволяет выполнять удаленные команды на системах Windows с использованием протокола SMB (Server Message Block).

Здесь краткое объяснение используемых в команде параметров:
- `impacket-psexec`: Это команда для запуска утилиты psexec из Impacket.
- `codeby.cdb/administrator`: Этот параметр указывает домен и имя пользователя для подключения к удаленной системе.
- `192.168.2.3`: Этот параметр указывает IP-адрес удаленной системы, на которой необходимо выполнить команду.
- `-hashes хэш`: Этот параметр указывает хэши LM и NTLM для аутентификации на удаленной системе. В данном случае указан только хэш NTLM, т.к. хэш LM отключен по умолчанию на современных системах Windows.

Команда попытается подключиться к удаленной системе по указанному IP-адресу с использованием указанных учетных данных и выполнить команду, указанную в командной строке. Если команда не указана, то по умолчанию будет выполнена команда `cmd.exe`.

---
Если что-то пошло не так:
```cd c:/Users``` -- дальше найдете путь сам ^-^

![[Pasted image 20240626013629.png]]

p.s. если опять проблемы и вы не знаете, как прочитать файл, то вот: 
`type root.txt`

Домен скомпрометирован!

---
### Немножко полезной литературы по детекту атак

Возможные варианты детектирования DCSync: https://habr.com/ru/companies/rvision/articles/709942/
Детект Pass-The-Hash: http://www.oszone.net/14579/Pass-the-Hash

## Спасибо автору за такую статью! 
p.s. я лишь дополнил немного своим текстом и все.... ^-^

Не забываем:
`sudo neo4j stop`
